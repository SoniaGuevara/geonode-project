{% load static %}
{% load get_menu_json %}
{% get_menu_json 'TOPBAR_MENU' as TOPBAR_MENU %}
{% get_menu_json 'TOPBAR_MENU_LEFT' as TOPBAR_MENU_LEFT %}
{% get_menu_json 'TOPBAR_MENU_RIGHT' as TOPBAR_MENU_RIGHT %}

<nav id="gn-brand-navbar" class="gn-brand-navbar ms-main-colors _padding-md ms-flex-box _flex">
    <div class="ms-flex-fill ms-flex-box _flex _flex-gap-sm _flex-center-v">

        <!-- Logo -->
        <a href="/" style="display:flex;align-items:center;text-decoration:none;flex:1;">
            {% if custom_theme.logo and custom_theme.logo.url %}
                <img src="{{ custom_theme.logo.url }}" style="height:44px;" alt="CRISOL UNCUYO">
            {% else %}
                <img src="{% static 'img/logo_crisol.png' %}" style="height:44px;" alt="CRISOL UNCUYO">
            {% endif %}
        </a>

        <!-- Menú oculto (necesario para el JS de GeoNode) -->
        <div class="gn-brand-navbar-left-menu-container ms-flex-fill ms-flex-box _flex _flex-gap-sm _flex-center-v" style="display:none!important;">
            <ul class="ms-flex-fill ms-flex-box _flex _flex-gap-sm _flex-center-v gn-brand-navbar-menu">
                {% include './brand_navbar_default_left_menu_items.html' %}
                {% for menu_item in TOPBAR_MENU %}
                    {% include './menu_item.html' with menu_item=menu_item %}
                {% endfor %}
                {% for menu_item in TOPBAR_MENU_LEFT %}
                    {% include './menu_item.html' with menu_item=menu_item %}
                {% endfor %}
            </ul>
        </div>

        <!-- Derecha: Register + Sign in (solo desktop) + hamburguesa -->
        <div style="display:flex;align-items:center;gap:0.6rem;">
            <div id="crisol-auth-btns" style="display:flex;align-items:center;gap:0.5rem;">
                {% include './brand_navbar_default_right_menu_items.html' %}
            </div>

            <!-- Botón hamburguesa -->
            <button id="crisol-menu-btn"
                style="background:none;border:1px solid #1a3f6f;border-radius:6px;padding:0.35rem 0.65rem;cursor:pointer;color:#1a3f6f;font-size:1.1rem;line-height:1;"
                onclick="document.getElementById('crisol-dropdown').classList.toggle('crisol-open')">
                <i class="fa fa-bars"></i>
            </button>
        </div>

    </div>
</nav>

<!-- Menú desplegable hamburguesa -->
<div id="crisol-dropdown" style="display:none;position:absolute;top:64px;right:1rem;z-index:9999;background:#ffffff;border:1px solid #e0e4e8;border-radius:8px;box-shadow:0 8px 24px rgba(0,0,0,0.12);min-width:200px;overflow:hidden;">
    <a href="/catalogue/#/?resource_type=dataset" style="display:block;padding:0.75rem 1.25rem;color:#1a3f6f;font-family:'Open Sans',sans-serif;font-size:0.875rem;font-weight:600;text-decoration:none;border-bottom:1px solid #f0f0f0;" onmouseover="this.style.background='#f4f6f8'" onmouseout="this.style.background='#fff'">Datasets</a>
    <a href="/catalogue/#/?resource_type=document" style="display:block;padding:0.75rem 1.25rem;color:#1a3f6f;font-family:'Open Sans',sans-serif;font-size:0.875rem;font-weight:600;text-decoration:none;border-bottom:1px solid #f0f0f0;" onmouseover="this.style.background='#f4f6f8'" onmouseout="this.style.background='#fff'">Documentos</a>
    <a href="/catalogue/#/?resource_type=map" style="display:block;padding:0.75rem 1.25rem;color:#1a3f6f;font-family:'Open Sans',sans-serif;font-size:0.875rem;font-weight:600;text-decoration:none;border-bottom:1px solid #f0f0f0;" onmouseover="this.style.background='#f4f6f8'" onmouseout="this.style.background='#fff'">Mapas</a>
    <a href="/people/" style="display:block;padding:0.75rem 1.25rem;color:#1a3f6f;font-family:'Open Sans',sans-serif;font-size:0.875rem;font-weight:600;text-decoration:none;border-bottom:1px solid #f0f0f0;" onmouseover="this.style.background='#f4f6f8'" onmouseout="this.style.background='#fff'">Personas</a>
    <a href="/groups/" style="display:block;padding:0.75rem 1.25rem;color:#1a3f6f;font-family:'Open Sans',sans-serif;font-size:0.875rem;font-weight:600;text-decoration:none;" onmouseover="this.style.background='#f4f6f8'" onmouseout="this.style.background='#fff'">Grupos</a>
</div>

<!-- Barra inferior (requerida por GeoNode) -->
<div id="gn-brand-navbar-bottom" style="display:none!important;">
    <div class="gn-brand-navbar-menu dropdown">
        <button class="btn dropdown-toggle btn-default" type="button" data-toggle="dropdown">
            <i class="fa fa-bars"></i>
        </button>
        <ul class="dropdown-menu"></ul>
    </div>
    {% include './search_bar.html' with search_bar_id='gn-search-bar-bottom' %}
</div>

<script>
(function() {
    // Cerrar menú al hacer click fuera
    document.addEventListener('click', function(e) {
        var btn = document.getElementById('crisol-menu-btn');
        var menu = document.getElementById('crisol-dropdown');
        if (menu && btn && !btn.contains(e.target) && !menu.contains(e.target)) {
            menu.classList.remove('crisol-open');
        }
    });

    // Mostrar/ocultar con clase
    var style = document.createElement('style');
    style.textContent = '#crisol-dropdown.crisol-open { display: block !important; }';
    document.head.appendChild(style);

    // Sign in URL fix
    window.addEventListener('DOMContentLoaded', function() {
        var signInElement = document.getElementById("sign-in");
        if (signInElement && window.location.pathname !== '/account/login/') {
            var href = signInElement.getAttribute("href").split("next=")[0];
            var path_name = encodeURIComponent(window.location.pathname + window.location.search + window.location.hash);
            signInElement.setAttribute("href", href.concat("next=".concat(path_name)));
        }
    });
    window.addEventListener('hashchange', function() {
        var signInElement = document.getElementById("sign-in");
        if (signInElement && window.location.pathname !== '/account/login/') {
            var href = signInElement.getAttribute("href").split("next=")[0];
            var path_name = encodeURIComponent(window.location.pathname + window.location.search + window.location.hash);
            signInElement.setAttribute("href", href.concat("next=".concat(path_name)));
        }
    });
})();
</script>